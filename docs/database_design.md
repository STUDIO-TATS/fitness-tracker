# フィットネス施設管理システム データベース設計

## 概要

マルチテナント対応のフィットネス施設管理システムです。複数の会社が複数の支店・店舗を持ち、様々なタイプの施設（ジム、プール、ヨガスタジオ等）を運営できる柔軟な設計となっています。

## 主要な特徴

- **マルチテナント**: 複数の会社が同一システムを利用
- **柔軟な施設構成**: 支店がない会社も対応、様々な施設タイプに対応
- **QRコード連携**: 施設利用時にQRコードでアクティビティを記録
- **会社ごとのポイントシステム**: 各会社が独自のポイント制度を運用
- **横断的なアクティビティログ**: ユーザーは会社を超えて利用履歴を蓄積

## テーブル設計

### 1. 組織構造

#### companies（会社マスタ）
- 各フィットネス運営会社の基本情報
- 会社コードでユニーク識別

#### branches（支店マスタ）
- 支店情報（任意）
- 支店を持たない会社は直接施設を管理

#### facilities（施設マスタ）
- 実際の施設（ジム、プール、ヨガスタジオ等）
- 各施設にユニークなQRコードを生成
- facility_typeで施設の種類を分類

### 2. アクティビティ管理

#### activity_types（アクティビティタイプマスタ）
- 各施設で利用可能なアクティビティ
- 柔軟なカテゴリ分類（training, swimming, yoga, etc）
- 消費カロリー目安、必要器具等の情報

#### activity_logs（アクティビティログ）
- ユーザーの施設利用記録
- チェックイン・アウト時間、消費カロリー、距離等
- 会社横断で記録蓄積

### 3. ユーザー管理

#### user_profiles（ユーザープロファイル）
- 会社横断のユーザー基本情報
- Supabase Authと連携

#### user_memberships（メンバーシップ）
- ユーザーと会社の関係
- 会員番号、会員タイプ、有効期限等

### 4. ポイントシステム

#### point_systems（ポイントシステム設定）
- 会社ごとのポイント制度設定
- ポイント単位、換算レート、有効期限等

#### point_rules（ポイント付与ルール）
- アクティビティカテゴリごとの付与ルール
- セッションごと、時間ごとの付与設定

#### user_points（ユーザーポイント残高）
- 会社ごとのユーザーポイント残高

#### point_transactions（ポイント履歴）
- ポイントの獲得・使用・有効期限切れ等の履歴

### 5. 体測定記録

#### measurements（体測定記録）
- 体重、体脂肪率、筋肉量等の測定記録
- 会社横断で管理、どの施設で測定したかも記録

## 利用フロー

### 1. QRコード読み取りフロー

1. ユーザーが施設のQRコードを読み取り
2. facilities.qr_codeで施設を特定
3. その施設で利用可能なactivity_typesを表示
4. ユーザーがアクティビティを選択してチェックイン
5. activity_logsに記録開始
6. チェックアウト時に記録完了、ポイント付与

### 2. ポイント付与フロー

1. アクティビティ完了時にpoint_rulesを参照
2. 該当会社のポイントシステムに基づいて計算
3. user_pointsの残高を更新
4. point_transactionsに履歴を記録

## データ例

### 会社構成例

**フィットネスチェーンA**
- 渋谷支店
  - ジムフロア（筋トレ、有酸素運動）
  - プールエリア（水泳、アクアビクス）
- 新宿支店
  - ジムフロア

**ヨガスタジオB**（支店なし）
- ヨガスタジオメイン（ハタヨガ、ヴィンヤサヨガ、瞑想）

**アクアフィットネスC**（支店なし）
- メインプール（競泳、ウォーターウォーキング）
- リラクゼーションプール（リラクゼーション）

### ポイントシステム例

- **フィットネスチェーンA**: 1FCポイント = 1円、12ヶ月有効
- **ヨガスタジオB**: 1YPポイント = 1円、6ヶ月有効
- **アクアフィットネスC**: 1コイン = 2円、24ヶ月有効

## セキュリティ

Row Level Security（RLS）を実装し、以下のポリシーを適用：

- ユーザーは自分の情報（プロファイル、アクティビティログ、ポイント等）のみアクセス可能
- 公開情報（会社、施設、アクティビティタイプ）は誰でも参照可能
- マルチテナント環境でのデータ分離を確保

## 拡張性

- 新しい施設タイプの追加が容易
- 新しいアクティビティカテゴリの追加が容易
- 会社ごとの独自ルール設定が柔軟
- ポイントシステムの詳細なカスタマイズが可能