# Supabaseã®æ³¨æ„ç‚¹ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

## ğŸš¨ é‡è¦ãªæ³¨æ„ç‚¹

### 1. auth.usersãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®ç›´æ¥æ“ä½œ

#### âŒ é¿ã‘ã‚‹ã¹ãã“ã¨
```sql
-- ã“ã‚Œã¯å‹•ä½œã—ã¾ã›ã‚“ï¼
INSERT INTO auth.users (email, encrypted_password) 
VALUES ('test@example.com', crypt('password', gen_salt('bf')));
```

#### âœ… æ­£ã—ã„æ–¹æ³•
```bash
# Admin APIã‚’ä½¿ç”¨
curl -X POST "http://localhost:54321/auth/v1/admin/users" \
  -H "apikey: $SERVICE_ROLE_KEY" \
  -H "Authorization: Bearer $SERVICE_ROLE_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "password123",
    "email_confirm": true
  }'
```

ã¾ãŸã¯

```javascript
// JavaScriptã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
const { data, error } = await supabase.auth.admin.createUser({
  email: 'test@example.com',
  password: 'password123',
  email_confirm: true
})
```

### 2. RLSï¼ˆRow Level Securityï¼‰ãƒãƒªã‚·ãƒ¼

#### æ³¨æ„ç‚¹
- æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ãŸã‚‰å¿…ãšRLSã‚’æœ‰åŠ¹åŒ–ã™ã‚‹
- ãƒãƒªã‚·ãƒ¼ã‚’è¨­å®šã—ãªã„ã¨ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„
- service_roleã‚­ãƒ¼ã¯RLSã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯æ…é‡ã«æ‰±ã†ï¼‰

```sql
-- ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆå¾Œã¯å¿…ãšå®Ÿè¡Œ
ALTER TABLE public.your_table ENABLE ROW LEVEL SECURITY;

-- åŸºæœ¬çš„ãªãƒãƒªã‚·ãƒ¼ä¾‹
CREATE POLICY "Users can view own data" ON public.your_table
  FOR SELECT USING (auth.uid() = user_id);
```

### 3. ç’°å¢ƒå¤‰æ•°ã¨ã‚­ãƒ¼ã®ç®¡ç†

#### âš ï¸ çµ¶å¯¾ã«å…¬é–‹ã—ã¦ã¯ã„ã‘ãªã„ã‚‚ã®
- `service_role_key` - ç®¡ç†è€…æ¨©é™ã‚’æŒã¤
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç›´æ¥æ¥ç¶šæ–‡å­—åˆ—
- JWT ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ

#### å®‰å…¨ã«ä½¿ç”¨ã§ãã‚‹ã‚‚ã®
- `anon_key` - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ä½¿ç”¨å¯èƒ½
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆURL

### 4. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å–ã‚Šæ‰±ã„

#### é‡è¦ãªãƒ«ãƒ¼ãƒ«
1. **ä¸€åº¦é©ç”¨ã—ãŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ç·¨é›†ã—ãªã„**
2. **å¿…ãšãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆã—ã¦ã‹ã‚‰ãƒªãƒ¢ãƒ¼ãƒˆã«é©ç”¨**
3. **ç ´å£Šçš„ãªå¤‰æ›´ã¯æ…é‡ã«**

```bash
# æ­£ã—ã„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
pnpm db:migrate:new my_change    # æ–°è¦ä½œæˆ
pnpm db:reset                     # ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆ
pnpm db:push:remote              # å•é¡Œãªã‘ã‚Œã°ãƒªãƒ¢ãƒ¼ãƒˆã¸
```

### 5. ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºæ™‚ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®š

#### iOS/Androidã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼æ¥ç¶š
```javascript
// âŒ é–“é•ã„ - localhostã¯ä½¿ãˆãªã„
const SUPABASE_URL = 'http://localhost:54321'

// âœ… æ­£è§£ - å®Ÿéš›ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨
const SUPABASE_URL = 'http://192.168.1.100:54321'  // ã‚ãªãŸã®ãƒ­ãƒ¼ã‚«ãƒ«IP
```

### 6. Dockeré–¢é€£ã®æ³¨æ„ç‚¹

#### ãƒãƒ¼ãƒˆç«¶åˆ
```bash
# æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ãƒˆã‚’ç¢ºèª
lsof -i :54321
lsof -i :54322
lsof -i :54323
lsof -i :54324

# å¿…è¦ã«å¿œã˜ã¦Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢
docker stop $(docker ps -q)
```

#### ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™
- Dockerã®ãƒ¡ãƒ¢ãƒªå‰²ã‚Šå½“ã¦ã‚’ç¢ºèªï¼ˆæœ€ä½4GBæ¨å¥¨ï¼‰
- è¤‡æ•°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åŒæ™‚ã«å®Ÿè¡Œã™ã‚‹å ´åˆã¯æ³¨æ„

## ğŸ“‹ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. é–‹ç™ºãƒ•ãƒ­ãƒ¼

#### æ¨å¥¨ã•ã‚Œã‚‹é †åº
1. **ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆ** - ã—ã£ã‹ã‚Šã¨è¨ˆç”»
2. **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ** - å°ã•ãªå˜ä½ã§
3. **ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ** - å¾¹åº•çš„ã«
4. **å‹ç”Ÿæˆ** - TypeScriptã®æ©æµã‚’å—ã‘ã‚‹
5. **æœ¬ç•ªé©ç”¨** - æ…é‡ã«

### 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

#### åŸºæœ¬åŸå‰‡
- **æœ€å°æ¨©é™ã®åŸå‰‡** - å¿…è¦æœ€å°é™ã®æ¨©é™ã®ã¿ä»˜ä¸
- **ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼** - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã¨ã‚µãƒ¼ãƒãƒ¼å´ã®ä¸¡æ–¹ã§
- **ç›£æŸ»ãƒ­ã‚°** - é‡è¦ãªæ“ä½œã¯è¨˜éŒ²

```sql
-- ç›£æŸ»ç”¨ã®ãƒˆãƒªã‚¬ãƒ¼ä¾‹
CREATE OR REPLACE FUNCTION audit_log()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO audit_logs (
    table_name,
    operation,
    user_id,
    data,
    created_at
  ) VALUES (
    TG_TABLE_NAME,
    TG_OP,
    auth.uid(),
    row_to_json(NEW),
    NOW()
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥
```sql
-- é »ç¹ã«æ¤œç´¢ã•ã‚Œã‚‹åˆ—ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
CREATE INDEX idx_users_email ON auth.users(email);
CREATE INDEX idx_activities_user_date ON activities(user_id, created_at);

-- è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯é †åºãŒé‡è¦
CREATE INDEX idx_compound ON table_name(column1, column2);
```

#### ã‚¯ã‚¨ãƒªæœ€é©åŒ–
```javascript
// âŒ N+1å•é¡Œ
const users = await supabase.from('users').select('*')
for (const user of users.data) {
  const activities = await supabase
    .from('activities')
    .select('*')
    .eq('user_id', user.id)
}

// âœ… JOINã‚’ä½¿ç”¨
const users = await supabase
  .from('users')
  .select(`
    *,
    activities (*)
  `)
```

### 4. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ãƒªã‚«ãƒãƒª

#### å®šæœŸçš„ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
```bash
# ã‚¹ã‚­ãƒ¼ãƒã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
pnpm db:dump:remote > backups/schema_$(date +%Y%m%d).sql

# ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€ãƒ•ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
pg_dump $DATABASE_URL > backups/full_$(date +%Y%m%d).sql
```

### 5. ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

#### ç›£è¦–ã™ã¹ãé …ç›®
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ•°
- ã‚¯ã‚¨ãƒªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡
- APIå‘¼ã³å‡ºã—æ•°

## ğŸ¯ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®æ³¨æ„ç‚¹

### 1. ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆè¨­è¨ˆ

#### ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ã®ç¢ºä¿
```sql
-- ã™ã¹ã¦ã®RLSãƒãƒªã‚·ãƒ¼ã§company_idã‚’ãƒã‚§ãƒƒã‚¯
CREATE POLICY "Company isolation" ON public.data_table
  FOR ALL USING (
    company_id IN (
      SELECT company_id FROM company_users 
      WHERE user_id = auth.uid()
    )
  );
```

### 2. ãƒã‚¤ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ 

#### ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸€è²«æ€§
```javascript
// ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ã¯å¿…ãšãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§
const { data, error } = await supabase.rpc('award_points', {
  user_id: userId,
  points: 100,
  reason: 'Activity completion'
})
```

### 3. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½

#### æ¥ç¶šç®¡ç†
```javascript
// ä¸è¦ã«ãªã£ãŸã‚‰subscriptionã‚’è§£é™¤
const subscription = supabase
  .channel('room1')
  .on('postgres_changes', 
    { event: 'INSERT', schema: 'public', table: 'messages' },
    handleNewMessage
  )
  .subscribe()

// ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
subscription.unsubscribe()
```

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã®å•é¡Œ
- [ ] Dockerã‚³ãƒ³ãƒ†ãƒŠã¯èµ·å‹•ã—ã¦ã„ã‚‹ã‹ï¼Ÿ
- [ ] æ­£ã—ã„ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ï¼Ÿ
- [ ] ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã®è¨­å®šã¯ï¼Ÿ
- [ ] ç’°å¢ƒå¤‰æ•°ã¯æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ

### èªè¨¼ã®å•é¡Œ
- [ ] email_confirmedãŒtrueã«ãªã£ã¦ã„ã‚‹ã‹ï¼Ÿ
- [ ] ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼ã‚’æº€ãŸã—ã¦ã„ã‚‹ã‹ï¼Ÿ
- [ ] JWTãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ã¯ï¼Ÿ
- [ ] RLSãƒãƒªã‚·ãƒ¼ã¯æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å•é¡Œ
- [ ] é©åˆ‡ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
- [ ] N+1å•é¡Œã¯ç™ºç”Ÿã—ã¦ã„ãªã„ã‹ï¼Ÿ
- [ ] ä¸è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ãªã„ã‹ï¼Ÿ
- [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯æ´»ç”¨ã§ãã¦ã„ã‚‹ã‹ï¼Ÿ

## ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯

- [Supabaseå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://supabase.com/docs)
- [PostgreSQLå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.postgresql.org/docs/)
- [RLSè©³ç´°ã‚¬ã‚¤ãƒ‰](https://supabase.com/docs/guides/auth/row-level-security)
- [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°](https://supabase.com/docs/guides/platform/performance)